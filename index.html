<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S-Class System</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#003e41;        /* Rich Black (brand) */
      --card:#0b4f52;
      --field:#063a3d;
      --text:#f2f2f2;
      --muted:rgba(242,242,242,.70);
      --accent:#ecd4bd;    /* Dutch White (brand) */
      --accent2:rgba(236,212,189,.16);
      --border:rgba(236,212,189,.35);
      --danger:#ff6b6b;
      --ok:#7CFF9A;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{padding:20px;max-width:520px;margin:0 auto;}
    .card{background:var(--card);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.18);}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px;}
    h1{font-size:22px;margin:0 0 6px;line-height:1.1;}
    .subtitle{font-size:13px;color:var(--muted);margin:0;}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--accent2);color:var(--accent);white-space:nowrap;}
    .langbar{display:flex;gap:8px;margin:10px 0 14px;}
    .langbtn{
      flex:1;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--accent);
      font-weight:800;
      font-size:13px;
      cursor:pointer;
    }
    .langbtn.active{
      background:var(--accent);
      color:var(--bg);
      border-color:transparent;
    }

    label{display:block;font-size:13px;margin:14px 0 6px;color:var(--muted);}
    input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:none;
      font-size:15px;
      background:var(--field);
      color:var(--text);
      box-sizing:border-box;
      outline:none;
    }
    .row{display:flex;gap:10px;margin-top:12px;}
    .btn-mini{
      flex:1;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:14px;
      font-weight:800;
      background:transparent;
      color:var(--accent);
      cursor:pointer;
    }
    .btn{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:none;
      font-size:16px;
      font-weight:900;
      background:var(--accent);
      color:var(--bg);
      cursor:pointer;
      margin-top:14px;
    }
    .hint{font-size:12px;color:var(--muted);margin-top:8px;}
    .code{text-align:center;letter-spacing:6px;font-size:18px;font-weight:900;}
    .status{margin-top:12px;font-size:13px;text-align:center;color:var(--muted);}
    .status.error{color:var(--danger);}
    .status.ok{color:var(--ok);}
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="topbar">
        <div>
          <h1 id="t_title">Sign in</h1>
          <p class="subtitle" id="t_subtitle">S-Class internal system</p>
        </div>
        <div class="pill" id="t_pill">Email OTP</div>
      </div>

      <!-- Language selector (TOP) — ORDER: UZ, EN, RU -->
      <div class="langbar" aria-label="Language">
        <button id="btn_uz" class="langbtn" onclick="setLang('uz')">UZ</button>
        <button id="btn_en" class="langbtn" onclick="setLang('en')">EN</button>
        <button id="btn_ru" class="langbtn" onclick="setLang('ru')">RU</button>
      </div>

      <label id="t_email_label">Work email</label>
      <input id="email" type="email" placeholder="name@company.com" autocomplete="email"/>

      <div class="row">
        <button class="btn-mini" id="t_send" onclick="requestCode()">Send code</button>
        <button class="btn-mini" id="t_clear" onclick="clearAll()">Clear</button>
      </div>

      <div class="hint" id="t_hint">We’ll send a 6-digit code to your email. Code is valid for ~10 minutes.</div>

      <label id="t_code_label">6-digit code</label>
      <input id="code" maxlength="6" class="code" inputmode="numeric" placeholder="••••••"/>

      <button class="btn" id="t_verify" onclick="verifyCode()">Verify & Open</button>

      <div id="status" class="status"></div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  // ====== TEXTS (UZ / EN / RU) ======
  const TEXT = {
    uz:{
      title:"Kirish",
      subtitle:"S-Class ichki tizimi",
      pill:"Email OTP",
      email:"Ishchi pochta",
      send:"Kod yuborish",
      clear:"Tozalash",
      hint:"Elektron pochtangizga 6 xonali kod yuboramiz. Kod ~10 daqiqa amal qiladi.",
      code:"6 xonali kod",
      verify:"Tasdiqlash va ochish",
      sending:"Kod yuborilmoqda...",
      verifying:"Tekshirilmoqda...",
      enterEmail:"Iltimos, email kiriting.",
      enterCode:"Iltimos, 6 xonali kodni kiriting."
    },
    en:{
      title:"Sign in",
      subtitle:"S-Class internal system",
      pill:"Email OTP",
      email:"Work email",
      send:"Send code",
      clear:"Clear",
      hint:"We’ll send a 6-digit code to your email. Code is valid for ~10 minutes.",
      code:"6-digit code",
      verify:"Verify & Open",
      sending:"Sending code...",
      verifying:"Verifying...",
      enterEmail:"Please enter your email.",
      enterCode:"Please enter the 6-digit code."
    },
    ru:{
      title:"Вход",
      subtitle:"Внутренняя система S-Class",
      pill:"Email OTP",
      email:"Рабочая почта",
      send:"Отправить код",
      clear:"Очистить",
      hint:"Мы отправим 6-значный код на почту. Код действует ~10 минут.",
      code:"6-значный код",
      verify:"Проверить и войти",
      sending:"Отправляем код...",
      verifying:"Проверяем...",
      enterEmail:"Введите email.",
      enterCode:"Введите 6-значный код."
    }
  };

  // ====== Language logic ======
  function detectLang(){
    // 1) saved choice
    const saved = localStorage.getItem("sclass_lang");
    if (saved && TEXT[saved]) return saved;

    // 2) telegram language
    const lc = (tg?.initDataUnsafe?.user?.language_code || "").toLowerCase();
    if (lc.startsWith("uz")) return "uz";
    if (lc.startsWith("ru")) return "ru";
    return "en";
  }

  let LANG = detectLang();

  function setLang(lang){
    LANG = lang;
    localStorage.setItem("sclass_lang", lang);
    render();
  }

  function render(){
    const T = TEXT[LANG] || TEXT.en;

    document.getElementById("t_title").innerText = T.title;
    document.getElementById("t_subtitle").innerText = T.subtitle;
    document.getElementById("t_pill").innerText = T.pill;

    document.getElementById("t_email_label").innerText = T.email;
    document.getElementById("t_send").innerText = T.send;
    document.getElementById("t_clear").innerText = T.clear;
    document.getElementById("t_hint").innerText = T.hint;
    document.getElementById("t_code_label").innerText = T.code;
    document.getElementById("t_verify").innerText = T.verify;

    // active buttons (ORDER stays UZ, EN, RU)
    document.getElementById("btn_uz").classList.toggle("active", LANG==="uz");
    document.getElementById("btn_en").classList.toggle("active", LANG==="en");
    document.getElementById("btn_ru").classList.toggle("active", LANG==="ru");
  }

  render();

  // ====== STATUS helpers ======
  function setStatus(msg, type=""){
    const el = document.getElementById("status");
    el.className = "status" + (type ? " " + type : "");
    el.innerText = msg || "";
  }

  function clearAll(){
    document.getElementById("email").value = "";
    document.getElementById("code").value = "";
    setStatus("");
  }

  // ====== BACKEND placeholders (Make.com) ======
  // Пока Make.com не подключен — это заглушки.
  // Потом сюда вставим реальный URL webhook.
  const MAKE_WEBHOOK_URL = ""; // <-- позже вставим

  async function requestCode(){
    const T = TEXT[LANG] || TEXT.en;
    const email = (document.getElementById("email").value || "").trim().toLowerCase();
    if (!email){
      setStatus(T.enterEmail, "error");
      return;
    }

    setStatus(T.sending);

    // Заглушка, пока не подключён Make.com
    if (!MAKE_WEBHOOK_URL){
      setStatus("✅ UI ready. Connect Make.com webhook to send real emails.", "ok");
      return;
    }

    try{
      const res = await fetch(MAKE_WEBHOOK_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          action:"request_otp",
          email,
          tg_user_id: tg?.initDataUnsafe?.user?.id || null
        })
      });
      const data = await res.json();
      if (data?.ok){
        setStatus("✅ Code sent", "ok");
      }else{
        setStatus(data?.error || "❌ Access denied", "error");
      }
    }catch(e){
      setStatus("❌ Network error", "error");
    }
  }

  async function verifyCode(){
    const T = TEXT[LANG] || TEXT.en;
    const email = (document.getElementById("email").value || "").trim().toLowerCase();
    const code = (document.getElementById("code").value || "").trim();

    if (!email){ setStatus(T.enterEmail, "error"); return; }
    if (!code || code.length !== 6){ setStatus(T.enterCode, "error"); return; }

    setStatus(T.verifying);

    // Заглушка, пока не подключён Make.com
    if (!MAKE_WEBHOOK_URL){
      setStatus("✅ OTP check will work after Make.com подключим.", "ok");
      return;
    }

    try{
      const res = await fetch(MAKE_WEBHOOK_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          action:"verify_otp",
          email,
          code,
          tg_user_id: tg?.initDataUnsafe?.user?.id || null
        })
      });
      const data = await res.json();
      if (data?.ok){
        setStatus("✅ Access granted", "ok");
        // тут позже откроем меню/перекинем на основной экран
      }else{
        setStatus(data?.error || "❌ Invalid code", "error");
      }
    }catch(e){
      setStatus("❌ Network error", "error");
    }
  }
</script>
</body>
</html>
